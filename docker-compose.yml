services:
  mariadb:
    image: mariadb:11
    container_name: mariadb
    dns:
      - 8.8.8.8
      - 8.8.4.4    
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: deslocafacil
    volumes:
      - db_data:/var/lib/mysql
      
  backend:
    build: ./backend
    container_name: deslocafacil-backend
    ports:
      - "8443:8443"
    depends_on:
      - mariadb   # garante que o container do banco sobe antes
     
    environment:
      # Variáveis sensíveis vindas do SSM (o user-data exporta antes de rodar o compose)
      DB_USER: "${DB_USER}"
      DB_PASSWORD: "${DB_PASSWORD}"
      DB_URL: "${DB_URL}"
      FLYWAY_URL: "${FLYWAY_URL}"
      FLYWAY_USER: "${FLYWAY_USER}"
      FLYWAY_PASSWORD: "${FLYWAY_PASSWORD}"

      # Caminho das chaves (se o backend estiver configurado para usar TLS com PEM)
      TLS_KEY_PATH: "/app/ssl/key.pem"
      TLS_CERT_PATH: "/app/ssl/cert.pem"

    restart: unless-stopped
    
  frontend:
    build: ./frontend
    container_name: deslocafacil-frontend
    dns:
      - 8.8.8.8
      - 8.8.4.4
    depends_on:
      - backend
    ports:
      - "443:443"    

volumes:
  db_data:    
